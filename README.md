# 张正友标定法的流程实现尝试

这是一个基于张正友标定法实现的相机标定工具，使用OpenCV和Eigen库进行开发。该工具可以通过检测棋盘格图案来标定相机的内参和畸变参数，并提供实时去畸变预览功能。

## 功能特性

- 实时检测棋盘格角点（支持亚像素优化）
- 自动采样优化（避免采集相似姿态的样本，提高样本覆盖度）
- Zhang 闭式解计算相机内参初值
- 估计畸变参数初值（径向畸变为主）
- 基于 Levenberg–Marquardt（OpenCV `calibrateCamera`）的非线性优化，最小化重投影误差，获得更稳定/精确的内参与畸变参数
- 标定完成后实时去畸变预览
- 支持将标定结果保存为 YAML 文件（兼容常见相机标定格式）

## 依赖项

- OpenCV 3.0 或更高版本
- Eigen3
- CMake 3.10 或更高版本
- C++20 兼容编译器

## 编译说明

```bash
cmake -S . -B build
cmake --build build
```

## 使用方法

### 基本用法

```bash
./calibrateCamera <cols> <rows> <square_size>
```

参数说明：
- `cols`: 棋盘格列数（横向角点数）
- `rows`: 棋盘格行数（纵向角点数）
- `square_size`: 棋盘格每个方格的边长（单位：毫米或其他一致单位）

例如，对于一个8x6的棋盘格，每个方格边长为25mm：
```bash
./calibrateCamera 8 6 25
```

### 操作指南

运行程序后，将显示两个窗口：
1. `live`: 实时摄像头画面，带有棋盘格检测结果和操作提示
2. `undistorted`: 去畸变后的画面（标定完成后显示）

界面中的进度条显示了样本在各个维度上的覆盖情况：
- X-pos: X方向位置覆盖度
- Y-pos: Y方向位置覆盖度
- Size: 尺寸覆盖度
- Skew: 倾斜度覆盖度

键盘操作：
- `a`: 切换自动采样模式开/关
- `s`: 手动保存当前帧作为标定样本
- `c`: 开始标定计算
- `w`: 将标定结果写入YAML文件
- `q` 或 `ESC`: 退出程序

### 自动采样模式

为了获得更好的标定效果，程序实现了自动采样机制。该机制会评估每帧棋盘格的姿态（位置、大小、倾斜度），只保留与已有样本差异较大的新样本，避免采集过多相似姿态的样本。

## 输出文件

标定完成后，可以按`w`键将结果保存为`camera_param.yaml`文件，包含以下信息：
- `image_width`: 图像宽度
- `image_height`: 图像高度
- `camera_matrix`: 相机内参矩阵
- `distortion_coefficients`: 畸变系数